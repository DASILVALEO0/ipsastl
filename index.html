<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>3D STL IPSA</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            background: #111827;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: #e5e7eb;
        }
        #container {
            width: 100%;
            height: 100%;
            position: fixed;
            inset: 0;
        }
        #overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 8px;
            font-size: 13px;
        }
        #overlay strong {
            color: #38bdf8;
        }
        #buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .btn {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #111827;
            cursor: pointer;
            color: #e5e7eb;
        }
        .btn:hover {
            background: #1f2937;
        }
        #pieceSelect {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #374151;
            background: #111827;
            color: #e5e7eb;
            cursor: pointer;
            min-width: 150px;
        }
        #pieceSelect:hover {
            background: #1f2937;
        }
        #pieceSelect option {
            background: #1f2937;
            color: #e5e7eb;
        }
        #loadingIndicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.9);
            padding: 20px;
            border-radius: 8px;
            font-size: 16px;
            color: #38bdf8;
            display: none;
        }
        
        #lightPanel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #374151;
        }
        #lightPanel h3 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #38bdf8;
            text-align: center;
        }
        .light-controls {
            display: grid;
            grid-template-columns: repeat(3, 30px);
            gap: 4px;
            margin-bottom: 8px;
        }
        .light-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #374151;
            background: #111827;
            border-radius: 4px;
            cursor: pointer;
            color: #e5e7eb;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .light-btn:hover {
            background: #1f2937;
            border-color: #38bdf8;
        }
        .light-btn:active {
            background: #38bdf8;
        }
        .light-intensity {
            margin-top: 8px;
        }
        .light-intensity label {
            font-size: 11px;
            display: block;
            margin-bottom: 4px;
            color: #9ca3af;
        }
        .light-intensity input {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #374151;
            outline: none;
            border-radius: 2px;
        }
        .light-intensity input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #38bdf8;
            cursor: pointer;
            border-radius: 50%;
        }
        .light-intensity input::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #38bdf8;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        .light-reset {
            width: 100%;
            margin-top: 8px;
            font-size: 11px;
            padding: 4px;
        }
    </style>
</head>
<body>
<div id="container"></div>

<div id="overlay">
    <div><strong>Rotation :</strong> clic gauche + drag</div>
    <div><strong>Zoom :</strong> molette</div>
    <div><strong>D√©placement :</strong> clic droit + drag</div>
</div>

<div id="buttons">
    <select id="pieceSelect">
        <option value="">Choisir une pi√®ce...</option>
    </select>
    <button class="btn" id="toggleProj">Projection : perspective</button>
    <button class="btn" id="resetCamera">Reset cam√©ra</button>
</div>

<div id="lightPanel">
    <h3>üí° Lumi√®re</h3>
    <div class="light-controls">
        <div></div>
        <button class="light-btn" id="lightUp" title="Haut">‚Üë</button>
        <div></div>
        <button class="light-btn" id="lightLeft" title="Gauche">‚Üê</button>
        <button class="light-btn" id="lightCenter" title="Centre">‚äô</button>
        <button class="light-btn" id="lightRight" title="Droite">‚Üí</button>
        <div></div>
        <button class="light-btn" id="lightDown" title="Bas">‚Üì</button>
        <div></div>
    </div>
    <div class="light-intensity">
        <label>Intensit√© : <span id="intensityValue">0.8</span></label>
        <input type="range" id="lightIntensity" min="0" max="2" step="0.1" value="0.8">
    </div>
    <button class="btn light-reset" id="resetLight">R√©initialiser</button>
</div>

<div id="loadingIndicator">Chargement de la pi√®ce...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>

<script>
    const PIECES = [
        {
            nom: "DC TT MOTOR",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/dc_tt_motor.stl"
        },
        {
            nom: "Battery Slot",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/Battery_slot.stl"
        },
        {
            nom: "Motor",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/motor.stl"
        },
        {
            nom: "Motor Bracket",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/motor_bracket.stl"
        },
        {
            nom: "Ultrasonic",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/ultrasonic_catv3.stl"
        },
        {
            nom: "Voltage Regulator",
            url: "https://raw.githubusercontent.com/DASILVALEO0/ipsastl/refs/heads/main/voltage_regulator.stl"
        },
    ];

    var scene, renderer, controls, mesh;
    var perspCamera, orthoCamera, currentCamera;
    var initialCamPos = new THREE.Vector3();
    var initialTarget = new THREE.Vector3();
    var isOrtho = false;
    var currentSTL_URL = null;

    var dirLight, backLight;
    var lightPosition = new THREE.Vector3(50, 100, 50);
    var initialLightPos = new THREE.Vector3(50, 100, 50);
    var lightStep = 20;

    var container = document.getElementById('container');
    var pieceSelect = document.getElementById('pieceSelect');
    var loadingIndicator = document.getElementById('loadingIndicator');
    var intensitySlider = document.getElementById('lightIntensity');
    var intensityValue = document.getElementById('intensityValue');

    function initScene() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111827);

        var aspect = window.innerWidth / window.innerHeight;
        perspCamera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
        perspCamera.position.set(80, 60, 80);

        var frustumSize = 200;
        var orthoHeight = frustumSize;
        var orthoWidth = frustumSize * aspect;
        orthoCamera = new THREE.OrthographicCamera(
            -orthoWidth / 2, orthoWidth / 2,
            orthoHeight / 2, -orthoHeight / 2,
            0.1, 1000
        );
        orthoCamera.position.copy(perspCamera.position);
        orthoCamera.lookAt(0, 0, 0);

        currentCamera = perspCamera;
        initialCamPos.copy(currentCamera.position);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        var hemiLight = new THREE.HemisphereLight(0xffffff, 0x111827, 0.6);
        scene.add(hemiLight);

        dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.copy(lightPosition);
        scene.add(dirLight);

        backLight = new THREE.DirectionalLight(0xffffff, 0.4);
        backLight.position.set(-50, -40, -50);
        scene.add(backLight);

        var grid = new THREE.GridHelper(200, 20, 0x374151, 0x1f2937);
        scene.add(grid);

        controls = new THREE.OrbitControls(currentCamera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        initialTarget.copy(controls.target);
    }

    function populateDropdown() {
        pieceSelect.innerHTML = '<option value="">Choisir une pi√®ce...</option>';
        
        PIECES.forEach((piece, index) => {
            const option = document.createElement('option');
            option.value = piece.url;
            option.textContent = piece.nom;
            pieceSelect.appendChild(option);
        });
    }

    function loadSTL(url) {
        if (! url || url === currentSTL_URL) return;
        
        currentSTL_URL = url;
        loadingIndicator.style.display = 'block';

        if (mesh) {
            scene.remove(mesh);
            if (mesh.geometry) mesh.geometry.dispose();
            if (mesh.material) mesh.material.dispose();
        }

        var loader = new THREE.STLLoader();
        loader.load(
            url,
            function (geometry) {
                geometry.computeBoundingBox();
                geometry.computeVertexNormals();

                var material = new THREE.MeshPhongMaterial({
                    color: 0x60a5fa,
                    specular: 0x111827,
                    shininess: 80
                });

                mesh = new THREE.Mesh(geometry, material);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);

                var bbox = geometry.boundingBox;
                var center = new THREE.Vector3();
                bbox.getCenter(center);
                mesh.position.sub(center);

                var size = new THREE.Vector3();
                bbox.getSize(size);
                var maxDim = Math.max(size.x, size.y, size.z);
                var scaleFactor = 80 / maxDim;
                mesh.scale.setScalar(scaleFactor);

                controls.target.set(0, 0, 0);
                controls.update();

                loadingIndicator.style.display = 'none';
            },
            undefined,
            function (error) {
                console.error('Erreur lors du chargement du STL :', error);
                alert('Impossible de charger le fichier STL : ' + url);
                loadingIndicator.style.display = 'none';
            }
        );
    }

    function updateLightPosition() {
        dirLight.position.copy(lightPosition);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, currentCamera);
    }

    initScene();
    populateDropdown();

    const params = new URLSearchParams(window.location.search);
    const stlParam = params.get('stl');
    if (stlParam) {
        const decodedURL = decodeURIComponent(stlParam);
        loadSTL(decodedURL);
        const matchingPiece = PIECES.find(piece => piece.url === decodedURL);
        if (matchingPiece) {
            pieceSelect.value = decodedURL;
        }
    }

    animate();

    
    pieceSelect.addEventListener('change', function() {
        const selectedURL = this.value;
        if (selectedURL) {
            loadSTL(selectedURL);
            const newURL = new URL(window.location);
            newURL.searchParams.set('stl', encodeURIComponent(selectedURL));
            window.history.replaceState({}, '', newURL);
        }
    });

    document.getElementById('lightUp').addEventListener('click', function() {
        lightPosition.y += lightStep;
        updateLightPosition();
    });

    document.getElementById('lightDown').addEventListener('click', function() {
        lightPosition.y -= lightStep;
        updateLightPosition();
    });

    document.getElementById('lightLeft').addEventListener('click', function() {
        lightPosition.x -= lightStep;
        updateLightPosition();
    });

    document.getElementById('lightRight').addEventListener('click', function() {
        lightPosition.x += lightStep;
        updateLightPosition();
    });

    document.getElementById('lightCenter').addEventListener('click', function() {
        lightPosition.z += lightStep;
        updateLightPosition();
    });

    document.getElementById('resetLight').addEventListener('click', function() {
        lightPosition.copy(initialLightPos);
        updateLightPosition();
        intensitySlider.value = 0.8;
        intensityValue.textContent = '0.8';
        dirLight.intensity = 0.8;
    });

    intensitySlider.addEventListener('input', function() {
        const value = parseFloat(this.value);
        intensityValue.textContent = value.toFixed(1);
        dirLight.intensity = value;
    });

    window.addEventListener('resize', function () {
        var width = window.innerWidth;
        var height = window.innerHeight;
        var aspect = width / height;

        perspCamera.aspect = aspect;
        perspCamera.updateProjectionMatrix();

        var frustumSize = 200;
        orthoCamera.left   = -frustumSize * aspect / 2;
        orthoCamera.right  =  frustumSize * aspect / 2;
        orthoCamera.top    =  frustumSize / 2;
        orthoCamera.bottom = -frustumSize / 2;
        orthoCamera.updateProjectionMatrix();

        renderer.setSize(width, height);
    });

    document.getElementById('toggleProj').addEventListener('click', function () {
        var btn = this;

        if (!isOrtho) {
            isOrtho = true;
            orthoCamera.position.copy(currentCamera.position);
            orthoCamera.up.copy(currentCamera.up);
            orthoCamera.lookAt(controls.target);
            currentCamera = orthoCamera;
            controls.object = currentCamera;
            controls.update();
            btn.textContent = 'Projection : parall√®le';
        } else {
            isOrtho = false;
            perspCamera.position.copy(currentCamera.position);
            perspCamera.up.copy(currentCamera.up);
            perspCamera.lookAt(controls.target);
            currentCamera = perspCamera;
            controls.object = currentCamera;
            controls.update();
            btn.textContent = 'Projection : perspective';
        }
    });

    document.getElementById('resetCamera').addEventListener('click', function () {
        currentCamera.position.copy(initialCamPos);
        controls.target.copy(initialTarget);
        controls.update();
    });
</script>
</body>
</html>
